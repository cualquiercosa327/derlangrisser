;
; Der Langrisser Name Screen Patches
;
; This files contains Super Nintendo code for redesigning the character naming
; interface in Der Langrisser.
;
; Version:   1.0
; Author:    byuu
; Copyright: (c) 2006, 2016 DL Team
; Website:   https://github.com/sobodash/derlangrisser/
; License:   BSD License <http://opensource.org/licenses/bsd-license.php>
;

lorom

org $01e141 : jsl load_char
org $01e150 : cmp #$02
org $01fbef : db $80
org $01e559 : jsl set_cursor : rts
org $01e4fe : db $b8,$05,$f8,$05,$38,$06
org $01dfea : lda #$05
org $01e6fc : jsl set_cp : bra $08


; ----------------------------------------------------------------------------
; Draw new A-Z and a-z character map

org $01dbf3
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $41,$00,$42,$00,$43,$00,$44,$00,$45,$00,$46,$00,$47,$00,$48,$00,$49,$00,$4a,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $4b,$00,$4c,$00,$4d,$00,$4e,$00,$4f,$00,$50,$00,$51,$00,$52,$00,$53,$00,$54,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $55,$00,$56,$00,$57,$00,$58,$00,$59,$00,$5a,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$4e,$5f,$76,$72
  db $5b,$00,$5c,$00,$5d,$00,$5e,$00,$5f,$00,$60,$00,$61,$00,$62,$00,$63,$00,$64,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$42,$5b,$5d,$65
  db $65,$00,$66,$00,$67,$00,$68,$00,$69,$00,$6a,$00,$6b,$00,$6c,$00,$6d,$00,$72,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$44,$69,$68,$5f
  db $73,$00,$74,$00,$75,$00,$76,$00,$77,$00,$78,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00


; ----------------------------------------------------------------------------
; Change default name to "Erwin"

org $00c5e7 : db $0e,$35,$58,$2c,$31,$00
org $07e352 : db $b5,$dc,$aa,$d3,$d8,$ff
org $01de46 : db $b5,$20,$dc,$20,$aa,$20,$d3,$20,$d8,$20,$20,$20,$20,$20,$20,$20,$ff


loadpc build/dl.xpc

lookup_table:
  db $01,$02,$03,$04,$05,$06,$07,$08,$09,$0a,$0b,$0c,$0d,$0e,$0f,$10
  db $11,$12,$13,$14,$15,$16,$17,$18,$19,$1a,$1b,$1c,$1d,$1e,$1f,$20
  db $21,$22,$23,$24,$25,$26,$27,$28,$29,$2a,$2b,$2c,$2d,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  db $00,$00,$00,$00,$00,$00,$3f,$40,$41,$42,$43,$2e,$2f,$30,$31,$32
  db $33,$34,$00,$00,$00,$00,$00,$35,$36,$37,$38,$39,$3a,$3b,$3c,$3d
  db $3e,$44,$45,$46,$47,$48,$49,$4a,$4b,$4c,$4d,$4e

set_cp() {
  php : rep #$30 : pha : phx : phy

; Verify that intro routine has not been disabled ...
;  lda $00fffc : cmp #$8000 : beq +
;  stp
;+ lda $008000 : cmp #$204c : beq +
;  stp
;+ lda $008002 : cmp #$d880 : beq +
;  stp
;+ lda $008020 : cmp #$005c : beq +
;  stp
;+ lda $008022 : cmp #$4080 : beq +
;  stp
;+

  ldx #$0000 : stx $fa
- {
    txa : cmp $7f67e3 : bcs +
    lda $7f67f8,x : and #$00ff : beq +
    phx
    sec : sbc #$000a : tax
    lda lookup_table,x : and #$00ff : tax
    lda $5f8000,x : and #$00ff ; Length table 0 address
    clc : adc $fa : sta $fa
    plx : inx : bra -
  }

+ ply : plx : pla : plp : rtl
}

set_cursor:
  adc $1f63
  sta $1f63
  bra test_ypos
ret_ypos:
  lda $1f62
  and #$c0
  beq test_xpos
ret_xpos:
  sta $1f62
  lda $7f67e0
  asl
  asl
  clc : adc $7f67e0
  clc : adc $7f67e1
  asl
  clc : adc #$02
  clc : adc $1f62
  sta $1f62
  rtl
test_xpos:
  pha
  lda $7f67e0
  cmp #$02
  beq reset_xpos
  pla
  bra ret_xpos
reset_xpos:
  lda #$00
  sta $7f67e1
  sta $7f67e0
  pla
  bra ret_xpos
test_ypos:
  lda $7f67e2
  cmp #$06
  bcs reset_ypos
  bra ret_ypos
reset_ypos:
  lda $1f62
  and #$3f
  sta $1f62
  lda #$05
  sta $1f63
  lda #$00
  sta $7f67e2
  bra ret_ypos
load_char:
  lda $7f67e2
  asl : asl : asl
  clc : adc $7f67e2
  clc : adc $7f67e2
  clc : adc $7f67e0
  clc : adc $7f67e0
  clc : adc $7f67e0
  clc : adc $7f67e0
  clc : adc $7f67e0
  clc : adc $7f67e1
  phx
  tax
  lda char_tbl,x
  plx
  rtl
char_tbl:
  db $b1,$b2,$b3,$b4,$b5,$b6,$b7,$b8,$b9,$ba
  db $bb,$bc,$bd,$be,$bf,$c0,$c1,$c2,$c3,$c4
  db $c5,$c6,$c7,$c8,$c9,$ca,$ae,$ae,$ae,$ae
  db $cb,$cc,$cd,$ce,$cf,$d0,$d1,$d2,$d3,$d4
  db $d5,$d6,$d7,$d8,$d9,$da,$db,$dc,$dd,$a7
  db $a8,$a9,$aa,$ab,$ac,$ad,$ae,$ae,$ae,$ae

savepc build/dl.xpc
